<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Developer Instructions • wqbench</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Developer Instructions">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">wqbench</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/Developer-instructions.html">Developer Instructions</a></li>
    <li><a class="dropdown-item" href="../articles/update-add-data-template.html">Update the Add Data Templates</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Developer Instructions</h1>
            
      

      <div class="d-none name"><code>Developer-instructions.Rmd</code></div>
    </div>

    
    
<!--
rmarkdown::html_vignette:
rmarkdown::github_document:

rmarkdown::render("vignettes/Developer-instructions.Rmd")
-->
<div class="section level2">
<h2 id="updating-reference-data-for-the-database">Updating Reference Data for the Database<a class="anchor" aria-label="anchor" href="#updating-reference-data-for-the-database"></a>
</h2>
<p>The Ecotox database is updated quarterly by the US EPA. Updating this
database within wqbench involves several steps including downloading the
new database, reviewing and updating reference files in the package, and
updating and redeploying the shiny app. The process below outlines the
steps necessary to update the wqbench package. The instructions to
update and redeploy the shinyapp can be found <a href="https://github.com/bcgov/shinywqbench?tab=readme-ov-file#shinywqbench" class="external-link">here</a>.</p>
<div class="section level3">
<h3 id="process">Process<a class="anchor" aria-label="anchor" href="#process"></a>
</h3>
<ol start="0" style="list-style-type: decimal">
<li><p>Download (clone or pull) the <code>wqbench</code> repo and open
in RStudio. The best practice is to open a new git branch, called
something like <code>update-[date-of-new-ecotox]</code>. In Rstudio, git
pane -&gt; New branch -&gt; give it a name, and check “Sync branch with
remote”.</p></li>
<li><p>Ensure you have the most recent copy of the database with the
reference files added. To do this, load the package, and run the
function <code><a href="../reference/wqb_create_data_set.html">wqb_create_data_set()</a></code>:</p></li>
</ol>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu">load_all</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/wqb_create_data_set.html">wqb_create_data_set</a></span><span class="op">(</span></span>
<span>  file_path <span class="op">=</span> <span class="st">"~/Ecotoxicology/ecotox"</span>,</span>
<span>  version <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  folder_path <span class="op">=</span> <span class="st">"~/Ecotoxicology/ecotox_db/"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Execute the code in the script
<em>scripts/review-reference-datasets-01.R</em>.</li>
</ol>
<ul>
<li>This script will generate and save a set of csv files that need to
be reviewed and updated to allow new values through the data cleaning
steps.</li>
<li>At the top of the script you will need to set the file path for the
database and the location to save the files that are generated. By
defeault they will save at:
<code>"~/Data/wqbench/[current-year]/review/to-be-reviewed/"</code>
</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li>After the files are generated, they need to be <a href="#review-process">reviewed and updated</a> by a technical
expert.</li>
</ol>
<ul>
<li>The next step must wait until the review is complete.</li>
<li>The life stage code file can’t be reviewed until after the trophic
groups have been updated.</li>
</ul>
<ol start="4" style="list-style-type: decimal">
<li>Once the files are reviewed they should be placed in:
<code>"~/Data/wqbench/[current-year]/review/completed/"</code>
</li>
</ol>
<ul>
<li>Then run the <em>scripts/update-reference-datasets-01.R</em>
script.</li>
<li>Run this line by line - You will be shown several displays showing
the updates that will be made to the internal data - ensure these look
ok. If they do, continue executing the script, if not you will need to
revisit your review and the changes you made to the csv files in the
<code>completed</code> folder.</li>
<li>This will read in the reviewed files and update the reference files
in the <em>inst/extdata</em> folder.</li>
</ul>
<ol start="5" style="list-style-type: decimal">
<li><p>The package needs to be re-built for the files to be part of the
package. Run <code>devtools::load_all()</code>.</p></li>
<li><p>Run the <code><a href="../reference/wqb_create_data_set.html">wqb_create_data_set()</a></code> function to create the
database with the new reference data.</p></li>
<li><p>To review/update the life stage codes, repeat steps 2 through 6
but run <em>scripts/review-reference-datasets-02.R</em>, review the
file, and run <em>scripts/update-reference-datasets-02.R</em>.The
trophic groups need to be updated before life stage codes can be
reviewed.</p></li>
<li><p>Run the <code><a href="../reference/wqb_create_data_set.html">wqb_create_data_set()</a></code> function again to
create the database with the new reference data.</p></li>
<li>
<p>These steps will have caused changes to several files in
<code>inst/extdata</code>. The changes will be shown in the Git pane in
RStudio. Commit these files to Git, and push it to GitHub. Go to the
GitHub repository, and open a pull request from your branch (created in
step 1). Best practice is to have someone review the PR, but if you know
the changes are good, you can merge it yourself. At the very least,
ensure that all of the automated checks pass before you merge.</p>
<p>9a. In rare cases, the “Add Data” templates may also need to be
updated after the reference files are updated. See the <a href="https://bcgov.github.io/wqbench/articles/update-add-data-template.html">“Update
the Add Data Templates</a> article for instructions.</p>
</li>
<li><p>Once your update is merged, install the new version:
<code>devtools::install_github("bcgov/wqbench")</code>.</p></li>
</ol>
</div>
<div class="section level3">
<h3 id="reference-file-review-process">Reference File Review Process<a class="anchor" aria-label="anchor" href="#reference-file-review-process"></a>
</h3>
<p>Below are instructions for how to fill out and complete each of the
reference files.</p>
<div class="section level4">
<h4 id="concentration-conversion">Concentration Conversion<a class="anchor" aria-label="anchor" href="#concentration-conversion"></a>
</h4>
<p>This data set should be reviewed each time a new version of the
database is downloaded.</p>
<ul>
<li>If there is no value in the <strong>conc_conversion_flag</strong>
column this indicates it is a new concentration unit that was not in the
previous version of the database.</li>
<li>The goal of the review is to ensure all cells in the
<strong>conc_conversion_flag</strong> column are filled in.
<ul>
<li>A zero (<code>0</code>) indicates the concentration cannot be
converted to mg/L or ppm.
<ul>
<li>If the units cannot be converted to mg/L or ppm then put a
<code>0</code> in the row.</li>
<li>No additional columns need to be filled in if the unit is given a
value of <code>0</code> in the <strong>conc_conversion_flag</strong>
column.</li>
</ul>
</li>
<li>A one (<code>1</code>) indicates the concentration can be converted
to mg/L or ppm.
<ul>
<li>If the units can be converted put a <code>1</code> in the row.
<ul>
<li>In the <strong>conc_conversion_value_multiplier</strong> column fill
in the value needed to convert the units into mg/L or ppm.</li>
<li>In the <strong>conc_conversion_unit</strong> column fill in either
<code>mg/L</code> or <code>ppm</code>.</li>
</ul>
</li>
</ul>
</li>
<li>Once completed, this file should be saved in the
<code>"completed"</code> subfolder in the review folder.</li>
</ul>
</li>
</ul>
<p>If any incorrect conversions are found, then those rows can be
updated.</p>
</div>
<div class="section level4">
<h4 id="duration-conversion">Duration Conversion<a class="anchor" aria-label="anchor" href="#duration-conversion"></a>
</h4>
<p>This data set should be reviewed each time a new version of the
database is downloaded.</p>
<ul>
<li>If there is no value in the <strong>duration_units_to_keep</strong>
column this indicates it is a new concentration unit that was not in the
previous version of the database.</li>
<li>The goal of the review is to ensure all cells in the
<strong>duration_units_to_keep</strong> column are filled in.
<ul>
<li>A zero (<code>0</code>) indicates the duration cannot be converted
to hours.
<ul>
<li>If the units cannot be converted to hours, then put a <code>0</code>
in the row.</li>
<li>No additional columns need to be filled in if the unit is given a
value of <code>0</code> in the <strong>duration_units_to_keep</strong>
column.</li>
</ul>
</li>
<li>A one (<code>1</code>) indicates the duration can be converted to
hours.
<ul>
<li>If the units can be converted put a <code>1</code> in the row.
<ul>
<li>In the <strong>duration_value_multiplier_to_hours</strong> column
fill in the value needed to convert the units into hours.</li>
<li>In the <strong>comments</strong> column write why the conversion was
chosen since there may be an assumption made during the conversion. For
example, if converting month into hours are you basing the conversion on
30 or 31 days.</li>
</ul>
</li>
</ul>
</li>
<li>Once completed, this file should be saved in the
<code>"completed"</code> subfolder in the review folder.</li>
</ul>
</li>
</ul>
<p>If any incorrect conversions are found, then those rows can be
updated.</p>
</div>
<div class="section level4">
<h4 id="trophic-groups">Trophic Groups<a class="anchor" aria-label="anchor" href="#trophic-groups"></a>
</h4>
<p>This data set should be reviewed each time a new version of the
database is downloaded.</p>
<ul>
<li>Two files will be generated to help review the trophic group data.
<ul>
<li>
<em>missing-trophic-group-review.csv</em>
<ul>
<li>This is a summary that shows the unique phylum, class, order, and
family of new taxa in the new version of Ecotox database, that do not
meet the exclusion criteria. In other words, these are candidate taxa to
be added to the internal dataset.</li>
<li>This file contains three columns for the reviewer to consider:
<strong>trophic_group</strong>, <strong>ecological_group</strong>, and
<strong>exclude_from_db</strong>.
<ul>
<li>If the taxon is not appropriate for inclusion, put a <code>1</code>
in the <strong>exclude_from_db</strong> column. Otherwise leave it
blank.</li>
<li>If it is appropriate to include, fill out the
<strong>trophic_group</strong> and <strong>ecological_group</strong>
columns. Valid values for <strong>trophic_group</strong> are:
“Invertebrate”, “Algae”, “Amphibian”, “Plant”, “Bacteria”, “Fish”. Valid
values for <strong>ecological_group</strong> are: “Planktonic
Invertebrate”, “Other”, “Salmonid”.</li>
<li>If there is a row in the “missing-trophic-review” sheet that doesn’t
have family or order, do one of two things: if the phylum/division is
really small and/or the whole taxon can be assigned an ecological group
and trophic group, do so. If not (e.g. Annelida, Arthropoda), put
<code>1</code> in the <strong>exclude_from_db</strong> column so that
this phylum/division won’t appear for you to review again, but lower
levels within that phylum/division will.</li>
</ul>
</li>
<li>Once completed, this file should be saved in the
<code>"completed"</code> subfolder in the review folder.</li>
</ul>
</li>
<li>
<em>species-coded-in-db-ref.csv</em>
<ul>
<li>This is a list of all the species data from the database that have
been filtered where <strong>organism_habitat</strong> is “Water”.</li>
<li>This file is for reference and not to be updated or sent back for
integration.</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level4">
<h4 id="life-stage-codes">Life Stage Codes<a class="anchor" aria-label="anchor" href="#life-stage-codes"></a>
</h4>
<p>This data set should be reviewed each time a new version of the
database is downloaded.</p>
<p>This data set will be sent separately after the first round of files
is reviewed because this data depends on the updates to the trophic
group data. Only fish and amphibian groups need the life stage
categorized into simple groups, so this file only contains fish and
amphibians.</p>
<p><em>lifestage-code-review.csv</em>: - If there is no value in the
<strong>simple_lifestage</strong> column this indicates it is a new life
stage that was not in the previous coding of the database. - The goal of
the review is to ensure all cells in the
<strong>simple_lifestage</strong> are filled in. - In the
<strong>simple_lifestage</strong> column fill in any empty cells with
either <code>els</code> (early life stage), <code>juvenile</code> or
<code>adult</code>.</p>
<p>Once completed, this file should be saved in the
<code>"completed"</code> subfolder in the review folder.</p>
</div>
<div class="section level4">
<h4 id="bc-species">BC Species<a class="anchor" aria-label="anchor" href="#bc-species"></a>
</h4>
<p>This reference dataset has not been included in the
<em>review-reference-datasets.R</em> script as it should not vary from
year to year.</p>
<p>This data set is a comprehensive list that was generated from B.C.
Conservation Data Centre.</p>
<p>Any species that is in ECOTOX, but not listed in the
<em>bc-species.csv</em> reference file is treated as not present in
BC.</p>
</div>
<div class="section level4">
<h4 id="concentration-endpoints">Concentration Endpoints<a class="anchor" aria-label="anchor" href="#concentration-endpoints"></a>
</h4>
<p>This reference dataset has not been included in the
<em>review-reference-datasets.R</em> script as it should not vary from
year to year.</p>
<p>There is a comprehensive list that should not need to be
adjusted.</p>
<p>The list of concentration endpoints are generated in the
<em>scripts/concentration-endpoints.R</em> script.</p>
<p>If updates are required then update the
<em>concentration-endpoints.R</em> script.</p>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Ayla Pearson, Angeline Tillmanns.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
