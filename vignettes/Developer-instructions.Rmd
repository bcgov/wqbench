---
title: "Developer-instructions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Developer-instructions}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(wqbench)
```

## Updating the Internal Data Set in the Shiny app

The shiny app is located in the [shinywqbench](https://github.com/bcgov/shinywqbench) repository. 
To update the internal data file

1. Go to the inst/extdata/data.R file.
2. Run the script.

This needs to occur each time the ECOTOX EPA data set is updated on the website.  

## How to Deploy the Shiny App

The shiny app is located in the [shinywqbench](https://github.com/bcgov/shinywqbench) repository.

1. Go to the scripts/deploy.R file.
2. Run the script.

It is advised to first run the code that deploys the app name of `shinywqbench-dev` and confirm the app deploys and functions as expected.
This app is referred to as the development app. 

Once it has been confirmed that the app functions and deploys properly to then run the second chunk of code with the app name `shinywqbench`.
This app is referred to as the production app. 

This will help to ensure the production app is always in a working state.

## Updating the Add Data Template

The instructions in the uploading data template need to up updated when any changes to the reference data sheets occur. 

- trophic-groups.csv
  - need to update trophic_group column and ecological_group column instructions if new groups are added or groups are removed
  - the groups have been manually added to the instruction tab
  - the validation is done off of the trophic-groups.csv so it is possible for the instructions to get out of sync with the allowed values
   
- lifestage-codes.csv
  - need to update simple_lifestage column instructions if new simple lifestages are added or removed 
  - the validation is done off of the lifestage-codes.csv so it is possible for the instructions to get out of sync with the allowed values
  
- concentration-endpoints.csv
  - need to update endpoint column instructions if endpoints are added or removed
  - the list of endpoints on the third sheet are generated using the function XXX, this needs to be run each time the concentration-endpoints.csv file is updated
  - the validation is done off of the concentration-endpoints.csv so it is possible for the instructions to get out of sync with the allowed values  
  
To regenerate the list of endpoints you will need to go to the *data-raw/template.R* file and run the script.
This will add the template section to the package and regenerate the list of allowed endpoint codes.

In the templates folder only the csv files should be updated manually.
The excel file is for people to use when filling in with their data and is generated from running the *data-raw/template.R* script.

## Updating Reference Data

### Overview of Process

1. Ensure you have the most recent copy of the database with the reference files added. To do this run the function `wqb_create_data_set()`.

```{r, eval=FALSE}
wqb_create_data_set(
  file_path = "~/Ecotoxicology/ecotox",
  version = 1,
  folder_path = "~/Ecotoxicology/ecotox_db/"
)
```

2. Execute the code in the script *scripts/review-reference-datasets.R*. 
   - This script will generate and save a set of csv files that need to be reviewed and updated to allow new values through the data cleaning steps. 
   - At the top of the script you will need to set the file path for the database and the location to save the files that are generated. 

3. After the files are generated they need to be reviewed and updated by a technical expert.
   - It is recommended to email them to the appropriate person for their review.
   - The next step has to wait until the review is complete. 

4. Once the files are reviewed the *script/update-reference-datasets.R* script needs to be run.
   - This will read in the reviewed files and update the reference files in the *inst/extdata* folder.

5. The package needs to be re-built for the files to be part of the package. 

Below are instructions for how to fill out and complete each of the reference files. 

### BC Species

This reference dataset has not been included in the *review-reference-datasets.R* script as it should not vary from year to year. 

This is a comprehensive list that was generated from B.C. Conservation Data Centre.

Any species that is not listed in the *bc-species.csv* reference file is marked as not present in BC and thus it is robust to new species added to the ECOTOX dataset.

### Concentration Endpoints

This reference dataset has not been included in the *review-reference-datasets.R* script as it should not vary from year to year. 

There is a comprehensive list that should not need to be adjusted. 

The list of concentration endpoints are generated in the *scripts/concentration-endpoints.R* script. 

If updates are required then update the *concentration-endpoints.R* script.

### Concentration Conversion

This data set should be reviewed each time a new version of the ECOTOX database is released. 

- If there is no value in the **conc_conversion_flag** column this indicates it is a new concentration unit that was not in the previous version of the database.
- The goal of the review is to ensure all cells in the **conc_conversion_flag** column are filled in. 
  - A zero (`0`) indicates the concentration cannot be converted to mg/L or ppm.
    - If the units cannot be converted to mg/L or ppm then put a `0` in the row.
    - No additional columns need to be filled in if the unit is given a value of `0` in the **conc_conversion_flag** column.
  - A one (`1`) indicates the concentration can be converted to mg/L or ppm. 
    - If the units can be converted put a `1` in the row. 
      - In the **conc_conversion_value_multiplier** column fill in the value needed to convert the units into mg/L or ppm. 
      - In the **conc_conversion_unit** column fill in either `mg/L` or `ppm`. 

If any incorrect conversions are found then those rows can be updated.

### Duration Conversion

This data set should be reviewed each time a new version of the ECOTOX database is released. 

- If there is no value in the **duration_units_to_keep** column this indicates it is a new concentration unit that was not in the previous version of the database.
- The goal of the review is to ensure all cells in the **duration_units_to_keep** column are filled in.   
  - A zero (`0`) indicates the duration cannot be converted to hours.
    - If the units cannot be converted to hours then put a `0` in the row.
    - No additional columns need to be filled in if the unit is given a value of `0` in the **duration_units_to_keep** column.
  - A one (`1`) indicates the duration can be converted to hours. 
    - If the units can be converted put a `1` in the row. 
      - In the **duration_value_multiplier_to_hours** column fill in the value needed to convert the units into hours. 
      - In the **comments** column write why the conversion was chosen since there may be an assumption made during the conversion. For example if converting month into hours are you basing the conversion on 30 or 31 days.   

If any incorrect conversions are found then those rows can be updated.

### Lifestage Codes

This data set should be reviewed each time a new version of the ECOTOX database is released. 

- If there is no value in the **simple_lifestage** column this indicates it is a new life stage that was not in the previous version of the database.
- The goal of the review is to ensure all cells in the **simple_lifestage** column are filled in.  
  - In the **simple_lifestage** column fill in the empty cell with either `els` (early life stage), `juvenile` or `adult`.

If any incorrect values are found then those rows can be updated.

### Trophic Groups

This data set should be reviewed each time a new pull from the ECOTOX data set is generated. 

After the database is created.

Run the script *scripts/review-trophic-groups.R* to generate two files for review.

The script will generate three files:

1. Species data from the database. 
   - Extra addition should be provided to species marked with a 1 in the be species column as these are species present in BC that are categorized into trophic groups.
   - This file is provided for reference but should not be used for listing the new groups to add to the reference dataset. 
2. A condensed list of the phylum, class, order and family of all the species that were not categorized with a trophic group.
  -  For groups that need to be added to the reference data set these need to `TRUE` written in the add column. The class and tax_order column will be joined to the class and order column in the reference dataset, they need to match identically or they cannot be joined. 
  - This file will be used to add the new trophic groups to the current reference file. 
3. The current reference data joined to the filtered and cleaned class and order list in the database. 

These files need to be reviewed and will guide any updates to the reference data for the trophic groups.
Update the file *inst/extdata/trophic-groups.csv* based on the review.

### After All Reference Datasets are Review

Once all the reference data sets have been reviewed and updated (as needed), re-build the package. 

Then restart your R session and create the dataset again. 

```{r, eval=FALSE}
wqb_create_data_set(
  file_path = "~/Ecotoxicology/ecotox",
  version = 1,
  folder_path = "~/Ecotoxicology/ecotox_db/"
)
```
